# =============================================================================
# Perth Turf Management System v2.0 â€” Home Assistant Package
# Save as: config/packages/lawn_care.yaml
# 
# NEW IN v2.0:
# âœ“ Multi-area support (up to 5 configurable areas)
# âœ“ Lawn type selector (affects GDD calculation)
# âœ“ Spray conditions forecast (wind + rain analysis)
# âœ“ PGR forecast (5-day GDD projection)
# âœ“ Number input fields (not sliders)
# âœ“ Generic entity configuration (3 YAML anchors)
#
# Author:  Generated for Perth, WA (Sandy Soil / Warm-Season Grass)
# Requires: Home Assistant 2024.1+, Weather Integration
# =============================================================================

# =============================================================================
# ðŸ”§ USER CONFIGURATION â€” EDIT THESE THREE LINES FOR YOUR SETUP
# =============================================================================

homeassistant:
  customize:
    sensor.lawn_gdd_today:
      friendly_name: "Today's GDD"
      icon: mdi:thermometer-lines
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # CONFIGURATION ANCHORS â€” Edit these three lines only
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Temperature sensor (must provide Â°C)
    # Examples: sensor.outdoor_temperature, sensor.weatherflow_sensors_temperature
    package.lawn_temp_sensor: &temp_sensor sensor.weatherflow_sensors_temperature
    
    # Notification service for reminders
    # Examples: notify.mobile_app_johns_phone, notify.all_devices
    package.lawn_notify_service: &notify_service notify.mobile_app_marcs_iphone
    
    # Weather forecast entity (for spray conditions + PGR forecast)
    # Examples: weather.home, weather.forecast_home, weather.openweathermap
    package.lawn_weather: &weather_forecast weather.home

# =============================================================================
# INPUT SELECT â€” Lawn Type
# =============================================================================

input_select:
  lawn_type:
    name: Lawn Type
    options:
      - "Cool Season (C3)"
      - "Warm Season (C4)"
      - "Bermuda"
      - "Kikuyu"
      - "Buffalo"
    initial: "Warm Season (C4)"
    icon: mdi:grass

# =============================================================================
# INPUT NUMBER â€” Lawn Areas, Rates, Intervals, GDD
# =============================================================================

input_number:

  # â”€â”€ Lawn Areas (5 configurable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Set unused areas to 0mÂ² to hide them
  
  lawn_area_1_size:
    name: "Area 1: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_2_size:
    name: "Area 2: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_3_size:
    name: "Area 3: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_4_size:
    name: "Area 4: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_5_size:
    name: "Area 5: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  # â”€â”€ Application Rates (per 100mÂ²) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  lawn_rate_granular_fert:
    name: Granular Fertiliser Rate
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: "g/100mÂ²"
    icon: mdi:shaker-outline
    mode: box

  lawn_rate_liquid_fert:
    name: Liquid Fertiliser Rate
    min: 0
    max: 500
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-circle
    mode: box

  lawn_rate_kelp:
    name: Kelp Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:seed
    mode: box

  lawn_rate_humate:
    name: Humate Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:cup-water
    mode: box

  lawn_rate_soil_wetter:
    name: Soil Wetter Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-percent
    mode: box

  lawn_rate_preemergent:
    name: Pre-emergent Rate
    min: 0
    max: 500
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:shield-bug
    mode: box

  lawn_rate_insecticide:
    name: Insecticide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:bug-outline
    mode: box

  lawn_rate_fungicide:
    name: Fungicide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:mushroom-outline
    mode: box

  lawn_rate_herbicide:
    name: Herbicide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:sprout-outline
    mode: box

  lawn_rate_pgr:
    name: PGR Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:expansion-card-variant
    mode: box

  # â”€â”€ Task Intervals (Days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  lawn_interval_mowing:
    name: Mowing Interval
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mower-on
    mode: box

  lawn_interval_kelp:
    name: Kelp Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:seed
    mode: box

  lawn_interval_granular_fert:
    name: Granular Fert Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shaker-outline
    mode: box

  lawn_interval_liquid_fert:
    name: Liquid Fert Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-circle
    mode: box

  lawn_interval_humate:
    name: Humate Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:cup-water
    mode: box

  lawn_interval_soil_wetter:
    name: Soil Wetter Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-percent
    mode: box

  lawn_interval_preemergent:
    name: Pre-emergent Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shield-bug
    mode: box

  lawn_interval_insecticide:
    name: Insecticide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:bug-outline
    mode: box

  lawn_interval_fungicide:
    name: Fungicide Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mushroom-outline
    mode: box

  lawn_interval_herbicide:
    name: Herbicide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:sprout-outline
    mode: box

  # â”€â”€ GDD Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  pgr_gdd_accumulated:
    name: Accumulated GDD
    min: 0
    max: 2000
    step: 0.1
    unit_of_measurement: "GDD"
    icon: mdi:chart-line
    mode: box

  pgr_gdd_target:
    name: Target GDD for PGR
    min: 50
    max: 500
    step: 10
    unit_of_measurement: "GDD"
    icon: mdi:target
    mode: box

  # â”€â”€ Temperature Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  lawn_temp_daily_max:
    name: "Today's Max Temp"
    min: -20
    max: 60
    step: 0.1
    unit_of_measurement: "Â°C"
    icon: mdi:thermometer-chevron-up
    mode: box

  lawn_temp_daily_min:
    name: "Today's Min Temp"
    min: -20
    max: 60
    step: 0.1
    unit_of_measurement: "Â°C"
    icon: mdi:thermometer-chevron-down
    mode: box

# =============================================================================
# INPUT TEXT â€” Area Names & Notes
# =============================================================================

input_text:
  
  # â”€â”€ Area Names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  lawn_area_1_name:
    name: "Area 1: Name"
    max: 50
    icon: mdi:label
    initial: "Front Yard"

  lawn_area_2_name:
    name: "Area 2: Name"
    max: 50
    icon: mdi:label
    initial: "Back Yard"

  lawn_area_3_name:
    name: "Area 3: Name"
    max: 50
    icon: mdi:label
    initial: "Side Yard"

  lawn_area_4_name:
    name: "Area 4: Name"
    max: 50
    icon: mdi:label
    initial: "Area 4"

  lawn_area_5_name:
    name: "Area 5: Name"
    max: 50
    icon: mdi:label
    initial: "Area 5"

  # â”€â”€ Task Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  lawn_task_notes:
    name: Task Notes
    max: 255
    icon: mdi:note-text

# =============================================================================
# INPUT DATETIME â€” Last Applied
# =============================================================================

input_datetime:
  lawn_last_mowing:
    name: Last Mowed
    has_date: true
    has_time: true
    icon: mdi:mower-on

  lawn_last_kelp:
    name: Last Kelp
    has_date: true
    has_time: true
    icon: mdi:seed

  lawn_last_granular_fert:
    name: Last Granular Fert
    has_date: true
    has_time: true
    icon: mdi:shaker-outline

  lawn_last_liquid_fert:
    name: Last Liquid Fert
    has_date: true
    has_time: true
    icon: mdi:water-circle

  lawn_last_humate:
    name: Last Humate
    has_date: true
    has_time: true
    icon: mdi:cup-water

  lawn_last_soil_wetter:
    name: Last Soil Wetter
    has_date: true
    has_time: true
    icon: mdi:water-percent

  lawn_last_preemergent:
    name: Last Pre-emergent
    has_date: true
    has_time: true
    icon: mdi:shield-bug

  lawn_last_insecticide:
    name: Last Insecticide
    has_date: true
    has_time: true
    icon: mdi:bug-outline

  lawn_last_fungicide:
    name: Last Fungicide
    has_date: true
    has_time: true
    icon: mdi:mushroom-outline

  lawn_last_herbicide:
    name: Last Herbicide
    has_date: true
    has_time: true
    icon: mdi:sprout-outline

  lawn_last_pgr:
    name: Last PGR
    has_date: true
    has_time: true
    icon: mdi:expansion-card-variant


# =============================================================================
# TEMPLATE SENSORS â€” GDD, Areas, Spray Conditions, PGR Forecast
# =============================================================================

template:
  - sensor:
  
      # â”€â”€ Temperature Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Daily Max Temp"
        unique_id: lawn_daily_max_temp
        state: >
          {{ states('input_number.lawn_temp_daily_max') | float(0) | round(1) }}
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-up

      - name: "Lawn Daily Min Temp"
        unique_id: lawn_daily_min_temp
        state: >
          {{ states('input_number.lawn_temp_daily_min') | float(0) | round(1) }}
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-down

      # â”€â”€ GDD Calculation (adjusts base temp by lawn type) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn GDD Today"
        unique_id: lawn_gdd_today
        state: >
          {% set max_temp = states('sensor.lawn_daily_max_temp') | float(0) %}
          {% set min_temp = states('sensor.lawn_daily_min_temp') | float(0) %}
          {% set lawn_type = states('input_select.lawn_type') %}
          {% if 'Cool Season' in lawn_type %}
            {% set base_temp = 5 %}
          {% else %}
            {% set base_temp = 10 %}
          {% endif %}
          {% set gdd = ((max_temp + min_temp) / 2) - base_temp %}
          {{ [gdd, 0] | max | round(1) }}
        unit_of_measurement: "GDD"
        icon: mdi:thermometer-lines
        attributes:
          lawn_type: "{{ states('input_select.lawn_type') }}"
          base_temperature: >
            {% if 'Cool Season' in states('input_select.lawn_type') %}5{% else %}10{% endif %}

      # â”€â”€ Total Lawn Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Total Area"
        unique_id: lawn_total_area
        state: >
          {{ (states('input_number.lawn_area_1_size') | float(0) +
              states('input_number.lawn_area_2_size') | float(0) +
              states('input_number.lawn_area_3_size') | float(0) +
              states('input_number.lawn_area_4_size') | float(0) +
              states('input_number.lawn_area_5_size') | float(0)) | round(0) }}
        unit_of_measurement: "mÂ²"
        icon: mdi:texture-box

      # â”€â”€ Spray Conditions: Wind Forecast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Wind Speed Forecast"
        unique_id: lawn_wind_speed_forecast
        state: >
          {% set forecast = state_attr('weather.home', 'forecast') %}
          {% if forecast %}
            {% set max_wind = namespace(value=0) %}
            {% for day in forecast[:1] %}
              {% if day.wind_speed is defined %}
                {% set wind = day.wind_speed | float(0) %}
                {% if wind > max_wind.value %}
                  {% set max_wind.value = wind %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ max_wind.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "km/h"
        icon: mdi:weather-windy
        device_class: wind_speed

      # â”€â”€ Spray Conditions: Rain Forecast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Rain Forecast"
        unique_id: lawn_rain_forecast
        state: >
          {% set forecast = state_attr('weather.home', 'forecast') %}
          {% if forecast %}
            {% set total_rain = namespace(value=0) %}
            {% for day in forecast[:1] %}
              {% if day.precipitation is defined %}
                {% set total_rain.value = total_rain.value + (day.precipitation | float(0)) %}
              {% endif %}
            {% endfor %}
            {{ total_rain.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "mm"
        icon: mdi:weather-pouring
        device_class: precipitation

      # â”€â”€ Spray Conditions: Suitability Rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Spray Conditions"
        unique_id: lawn_spray_conditions
        state: >
          {% set wind = states('sensor.lawn_wind_speed_forecast') | float(0) %}
          {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
          {% if wind > 25 or rain > 5 %}
            Poor
          {% elif wind > 15 or rain > 2 %}
            Marginal
          {% else %}
            Good
          {% endif %}
        icon: >
          {% set cond = states('sensor.lawn_spray_conditions') %}
          {% if cond == 'Good' %}mdi:check-circle
          {% elif cond == 'Marginal' %}mdi:alert-circle
          {% else %}mdi:close-circle{% endif %}
        attributes:
          wind_speed: "{{ states('sensor.lawn_wind_speed_forecast') }} km/h"
          rain_forecast: "{{ states('sensor.lawn_rain_forecast') }} mm"
          recommendation: >
            {% set cond = states('sensor.lawn_spray_conditions') %}
            {% if cond == 'Good' %}
              Ideal spray conditions. Low wind and minimal rain expected.
            {% elif cond == 'Marginal' %}
              Borderline conditions. Monitor wind and rain before spraying.
            {% else %}
              Poor conditions. High wind or rain forecast - delay spraying.
            {% endif %}

      # â”€â”€ Spray Conditions: Next Good Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn Next Spray Window"
        unique_id: lawn_next_spray_window
        state: >
          {% set forecast = state_attr('weather.home', 'forecast') %}
          {% if forecast %}
            {% set found = namespace(day='') %}
            {% for day in forecast[:7] %}
              {% if found.day == '' %}
                {% set wind = day.wind_speed | float(100) if day.wind_speed is defined else 100 %}
                {% set rain = day.precipitation | float(100) if day.precipitation is defined else 100 %}
                {% if wind < 15 and rain < 2 %}
                  {% set found.day = day.datetime if day.datetime is defined else 'Unknown' %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ found.day[:10] if found.day else 'No suitable window in next 7 days' }}
          {% else %}
            unavailable
          {% endif %}
        icon: mdi:calendar-check

      # â”€â”€ PGR Forecast: 5-Day GDD Projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn GDD Projection 5-Day"
        unique_id: lawn_gdd_projection_5day
        state: >
          {% set forecast = state_attr('weather.home', 'forecast') %}
          {% set lawn_type = states('input_select.lawn_type') %}
          {% if 'Cool Season' in lawn_type %}
            {% set base_temp = 5 %}
          {% else %}
            {% set base_temp = 10 %}
          {% endif %}
          {% if forecast %}
            {% set total_gdd = namespace(value=0) %}
            {% for day in forecast[:5] %}
              {% if day.temperature is defined and day.templow is defined %}
                {% set max_t = day.temperature | float(0) %}
                {% set min_t = day.templow | float(0) %}
                {% set daily_gdd = ((max_t + min_t) / 2) - base_temp %}
                {% set total_gdd.value = total_gdd.value + ([daily_gdd, 0] | max) %}
              {% endif %}
            {% endfor %}
            {{ total_gdd.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "GDD"
        icon: mdi:calendar-range
        attributes:
          base_temperature: >
            {% if 'Cool Season' in states('input_select.lawn_type') %}5{% else %}10{% endif %}
          lawn_type: "{{ states('input_select.lawn_type') }}"

      # â”€â”€ PGR Forecast: Days Until Target â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn PGR Days Until"
        unique_id: lawn_pgr_days_until
        state: >
          {% set current_gdd = states('input_number.pgr_gdd_accumulated') | float(0) %}
          {% set target_gdd = states('input_number.pgr_gdd_target') | float(200) %}
          {% set remaining = target_gdd - current_gdd %}
          {% if remaining <= 0 %}
            0
          {% else %}
            {% set daily_avg = states('sensor.lawn_gdd_today') | float(5) %}
            {% if daily_avg > 0 %}
              {{ (remaining / daily_avg) | round(0) }}
            {% else %}
              unavailable
            {% endif %}
          {% endif %}
        unit_of_measurement: "days"
        icon: mdi:calendar-clock
        attributes:
          current_gdd: "{{ states('input_number.pgr_gdd_accumulated') }}"
          target_gdd: "{{ states('input_number.pgr_gdd_target') }}"
          gdd_remaining: >
            {{ (states('input_number.pgr_gdd_target') | float(0) - 
                states('input_number.pgr_gdd_accumulated') | float(0)) | round(1) }}

      # â”€â”€ PGR Forecast: Estimated Application Date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: "Lawn PGR Forecast Date"
        unique_id: lawn_pgr_forecast_date
        state: >
          {% set current_gdd = states('input_number.pgr_gdd_accumulated') | float(0) %}
          {% set target_gdd = states('input_number.pgr_gdd_target') | float(200) %}
          {% set projection_5day = states('sensor.lawn_gdd_projection_5day') | float(0) %}
          {% if current_gdd >= target_gdd %}
            Now (Target Reached)
          {% elif current_gdd + projection_5day >= target_gdd %}
            {% set forecast = state_attr('weather.home', 'forecast') %}
            {% set lawn_type = states('input_select.lawn_type') %}
            {% if 'Cool Season' in lawn_type %}
              {% set base_temp = 5 %}
            {% else %}
              {% set base_temp = 10 %}
            {% endif %}
            {% if forecast %}
              {% set running_gdd = namespace(value=current_gdd) %}
              {% set found_date = namespace(value='') %}
              {% for day in forecast[:7] %}
                {% if found_date.value == '' %}
                  {% if day.temperature is defined and day.templow is defined %}
                    {% set max_t = day.temperature | float(0) %}
                    {% set min_t = day.templow | float(0) %}
                    {% set daily_gdd = ((max_t + min_t) / 2) - base_temp %}
                    {% set running_gdd.value = running_gdd.value + ([daily_gdd, 0] | max) %}
                    {% if running_gdd.value >= target_gdd %}
                      {% set found_date.value = day.datetime if day.datetime is defined else '' %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ found_date.value[:10] if found_date.value else '5+ days' }}
            {% else %}
              Unknown
            {% endif %}
          {% else %}
            5+ days
          {% endif %}
        icon: mdi:calendar-star


# =============================================================================
# SCRIPTS â€” Task Logging with Multi-Area Support
# =============================================================================

script:

  # Each script logs to datetime, creates logbook entry with per-area calculations,
  # and clears notes field. Areas with 0mÂ² size are automatically skipped.

  lawn_log_mowing:
    alias: "Log Mowing"
    icon: mdi:mower-on
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_mowing
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Lawn Mowing"
          message: >
            Mowed lawn (Total: {{ states('sensor.lawn_total_area') }}mÂ²).
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_mowing
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_kelp:
    alias: "Log Kelp"
    icon: mdi:seed
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_kelp
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Kelp Application"
          message: >
            Applied kelp at {{ states('input_number.lawn_rate_kelp') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_kelp') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_kelp
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_granular_fert:
    alias: "Log Granular Fert"
    icon: mdi:shaker-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_granular_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Granular Fertiliser"
          message: >
            Applied at {{ states('input_number.lawn_rate_granular_fert') }}g/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_granular_fert') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'g' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_granular_fert
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_liquid_fert:
    alias: "Log Liquid Fert"
    icon: mdi:water-circle
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_liquid_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Liquid Fertiliser"
          message: >
            Applied at {{ states('input_number.lawn_rate_liquid_fert') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_liquid_fert') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_liquid_fert
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_humate:
    alias: "Log Humate"
    icon: mdi:cup-water
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_humate
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Humate Application"
          message: >
            Applied at {{ states('input_number.lawn_rate_humate') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_humate') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_humate
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_soil_wetter:
    alias: "Log Soil Wetter"
    icon: mdi:water-percent
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_soil_wetter
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Soil Wetter"
          message: >
            Applied at {{ states('input_number.lawn_rate_soil_wetter') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_soil_wetter') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_soil_wetter
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_preemergent:
    alias: "Log Pre-emergent"
    icon: mdi:shield-bug
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_preemergent
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Pre-emergent"
          message: >
            Applied at {{ states('input_number.lawn_rate_preemergent') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_preemergent') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_preemergent
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_insecticide:
    alias: "Log Insecticide"
    icon: mdi:bug-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_insecticide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Insecticide"
          message: >
            Applied at {{ states('input_number.lawn_rate_insecticide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_insecticide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_insecticide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_fungicide:
    alias: "Log Fungicide"
    icon: mdi:mushroom-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_fungicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Fungicide"
          message: >
            Applied at {{ states('input_number.lawn_rate_fungicide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_fungicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_fungicide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_herbicide:
    alias: "Log Herbicide"
    icon: mdi:sprout-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_herbicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Herbicide"
          message: >
            Applied at {{ states('input_number.lawn_rate_herbicide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_herbicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_herbicide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_pgr:
    alias: "Log PGR"
    icon: mdi:expansion-card-variant
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_pgr
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "PGR Application"
          message: >
            Applied PGR at {{ states('input_number.lawn_rate_pgr') }}ml/100mÂ²
            ({{ states('input_number.pgr_gdd_accumulated') }} GDD â€” resetting to 0).
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_pgr') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_pgr
      - service: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: 0
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""


# =============================================================================
# AUTOMATIONS â€” Temperature, GDD, Reminders
# =============================================================================

automation:

  # â”€â”€ Temperature: Track Daily Max â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_temp_track_max
    alias: "Lawn: Track Daily Max"
    trigger:
      - platform: state
        entity_id: *temp_sensor
    condition:
      - condition: template
        value_template: >
          {{ states(*temp_sensor) | float(none) is not none
             and states(*temp_sensor) | float(0)
             > states('input_number.lawn_temp_daily_max') | float(-99) }}
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_max
        data:
          value: "{{ states(*temp_sensor) | float(0) | round(1) }}"

  # â”€â”€ Temperature: Track Daily Min â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_temp_track_min
    alias: "Lawn: Track Daily Min"
    trigger:
      - platform: state
        entity_id: *temp_sensor
    condition:
      - condition: template
        value_template: >
          {{ states(*temp_sensor) | float(none) is not none
             and states(*temp_sensor) | float(99)
             < states('input_number.lawn_temp_daily_min') | float(99) }}
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_min
        data:
          value: "{{ states(*temp_sensor) | float(0) | round(1) }}"

  # â”€â”€ Temperature: Reset at Midnight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_temp_reset_daily
    alias: "Lawn: Reset Daily Temperature"
    trigger:
      - platform: time
        at: "00:00:30"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_max
        data:
          value: "{{ states(*temp_sensor) | float(0) | round(1) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_min
        data:
          value: "{{ states(*temp_sensor) | float(0) | round(1) }}"

  # â”€â”€ GDD: Accumulate at Midnight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_gdd_accumulate
    alias: "Lawn: Accumulate GDD"
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: >
            {{ (states('input_number.pgr_gdd_accumulated') | float
                + states('sensor.lawn_gdd_today') | float) | round(1) }}

  # â”€â”€ GDD: PGR Threshold Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_pgr_gdd_alert
    alias: "Lawn: PGR GDD Alert"
    trigger:
      - platform: numeric_state
        entity_id: input_number.pgr_gdd_accumulated
        above: input_number.pgr_gdd_target
    action:
      - service: *notify_service
        data:
          title: "ðŸŒ± PGR Application Due"
          message: >
            GDD Target Reached! {{ states('input_number.pgr_gdd_accumulated') }} / {{ states('input_number.pgr_gdd_target') }} GDD.
            Forecast: Apply by {{ states('sensor.lawn_pgr_forecast_date') }}.
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_pgr') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Mowing Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_mowing_reminder
    alias: "Lawn: Mowing Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_mowing')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_mowing') | float(7) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸšœ Time to Mow"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_mowing'))) / 86400) | round(0) }} days since last mow.
            Total area: {{ states('sensor.lawn_total_area') }}mÂ²

  # â”€â”€ Kelp Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_kelp_reminder
    alias: "Lawn: Kelp Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_kelp')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_kelp') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸŒ¿ Kelp Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_kelp'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_kelp') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Granular Fert Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_granular_fert_reminder
    alias: "Lawn: Granular Fert Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_granular_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_granular_fert') | float(60) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ¥£ Granular Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_granular_fert'))) / 86400) | round(0) }} days overdue.
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_granular_fert') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'g' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Liquid Fert Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_liquid_fert_reminder
    alias: "Lawn: Liquid Fert Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_liquid_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_liquid_fert') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ’§ Liquid Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_liquid_fert'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_liquid_fert') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Humate Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_humate_reminder
    alias: "Lawn: Humate Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_humate')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_humate') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "â˜• Humate Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_humate'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_humate') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Soil Wetter Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_soil_wetter_reminder
    alias: "Lawn: Soil Wetter Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_soil_wetter')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_soil_wetter') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ’¦ Soil Wetter Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_soil_wetter'))) / 86400) | round(0) }} days overdue.
            Critical for Perth sandy soil!
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_soil_wetter') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Pre-emergent Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_preemergent_reminder
    alias: "Lawn: Pre-emergent Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_preemergent')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_preemergent') | float(120) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ›¡ï¸ Pre-emergent Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_preemergent'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_preemergent') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Insecticide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_insecticide_reminder
    alias: "Lawn: Insecticide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_insecticide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_insecticide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ› Insecticide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_insecticide'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_insecticide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Fungicide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_fungicide_reminder
    alias: "Lawn: Fungicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_fungicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_fungicide') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸ„ Fungicide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_fungicide'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_fungicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

  # â”€â”€ Herbicide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  - id: lawn_herbicide_reminder
    alias: "Lawn: Herbicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_herbicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_herbicide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: *notify_service
        data:
          title: "ðŸŒ± Herbicide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_herbicide'))) / 86400) | round(0) }} days overdue.
            Spray conditions: {{ states('sensor.lawn_spray_conditions') }}
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_herbicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ': ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}

