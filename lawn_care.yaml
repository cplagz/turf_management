# =============================================================================
# Perth Turf Management System â€” Home Assistant Package
# Save as: config/packages/lawn_care.yaml
# Author:  Generated for Perth, WA (Sandy Soil / Warm-Season Grass)
# Requires: Home Assistant 2024.1+
# =============================================================================

homeassistant:
  customize:
    sensor.lawn_gdd_today:
      friendly_name: "Today's GDD"
      icon: mdi:thermometer-lines
    sensor.lawn_daily_max_temp:
      friendly_name: "Daily Max Temperature"
    sensor.lawn_daily_min_temp:
      friendly_name: "Daily Min Temperature"

# =============================================================================
# INPUT HELPERS â€” Settings & Tracking
# =============================================================================

input_number:

  # â”€â”€ Lawn Areas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lawn_area_front:
    name: Front Lawn Area
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box

  lawn_area_back:
    name: Back Lawn Area
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box

  # â”€â”€ Application Rates (per 100mÂ²) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lawn_rate_granular_fert:
    name: Granular Fertiliser Rate
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: "g/100mÂ²"
    icon: mdi:shaker-outline

  lawn_rate_liquid_fert:
    name: Liquid Fertiliser Rate
    min: 0
    max: 500
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-circle

  lawn_rate_kelp:
    name: Kelp Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:seed

  lawn_rate_humate:
    name: Humate Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:cup-water

  lawn_rate_soil_wetter:
    name: Soil Wetter Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-percent

  lawn_rate_preemergent:
    name: Pre-emergent Rate
    min: 0
    max: 500
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:shield-bug

  lawn_rate_insecticide:
    name: Insecticide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:bug-outline

  lawn_rate_fungicide:
    name: Fungicide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:mushroom-outline

  lawn_rate_herbicide:
    name: Herbicide Rate
    min: 0
    max: 200
    step: 5
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:sprout-outline

  lawn_rate_pgr:
    name: PGR Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:expansion-card-variant

  # â”€â”€ Task Intervals (Days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lawn_interval_mowing:
    name: Mowing Interval
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mower-on

  lawn_interval_kelp:
    name: Kelp Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:seed

  lawn_interval_granular_fert:
    name: Granular Fert Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shaker-outline

  lawn_interval_liquid_fert:
    name: Liquid Fert Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-circle

  lawn_interval_humate:
    name: Humate Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:cup-water

  lawn_interval_soil_wetter:
    name: Soil Wetter Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-percent

  lawn_interval_preemergent:
    name: Pre-emergent Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shield-bug

  lawn_interval_insecticide:
    name: Insecticide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:bug-outline

  lawn_interval_fungicide:
    name: Fungicide Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mushroom-outline

  lawn_interval_herbicide:
    name: Herbicide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:sprout-outline

  # â”€â”€ GDD Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pgr_gdd_accumulated:
    name: Accumulated GDD Since Last PGR
    min: 0
    max: 2000
    step: 0.1
    unit_of_measurement: "GDD"
    icon: mdi:chart-line

  pgr_gdd_target:
    name: Target GDD for PGR Application
    min: 50
    max: 500
    step: 10
    unit_of_measurement: "GDD"
    icon: mdi:target

# =============================================================================
# INPUT DATETIME â€” Last Applied Dates
# =============================================================================

input_datetime:
  lawn_last_mowing:
    name: Last Mowed
    has_date: true
    has_time: true
    icon: mdi:mower-on

  lawn_last_kelp:
    name: Last Kelp Application
    has_date: true
    has_time: true
    icon: mdi:seed

  lawn_last_granular_fert:
    name: Last Granular Fert
    has_date: true
    has_time: true
    icon: mdi:shaker-outline

  lawn_last_liquid_fert:
    name: Last Liquid Fert
    has_date: true
    has_time: true
    icon: mdi:water-circle

  lawn_last_humate:
    name: Last Humate Application
    has_date: true
    has_time: true
    icon: mdi:cup-water

  lawn_last_soil_wetter:
    name: Last Soil Wetter
    has_date: true
    has_time: true
    icon: mdi:water-percent

  lawn_last_preemergent:
    name: Last Pre-emergent
    has_date: true
    has_time: true
    icon: mdi:shield-bug

  lawn_last_insecticide:
    name: Last Insecticide
    has_date: true
    has_time: true
    icon: mdi:bug-outline

  lawn_last_fungicide:
    name: Last Fungicide
    has_date: true
    has_time: true
    icon: mdi:mushroom-outline

  lawn_last_herbicide:
    name: Last Herbicide
    has_date: true
    has_time: true
    icon: mdi:sprout-outline

  lawn_last_pgr:
    name: Last PGR Application
    has_date: true
    has_time: true
    icon: mdi:expansion-card-variant

# =============================================================================
# INPUT TEXT â€” Task Notes
# =============================================================================

input_text:
  lawn_task_notes:
    name: Task Notes
    max: 255
    icon: mdi:note-text

# =============================================================================
# STATISTICS SENSORS â€” Accurate Daily Max / Min from WeatherFlow
# These use the built-in statistics platform to track the true 24-hour
# high and low from your WeatherFlow temperature sensor. They update
# continuously and reset naturally as readings roll out of the 24hr window.
# No external integration needed â€” this is pure HA core functionality.
# =============================================================================

sensor:
  - platform: statistics
    name: "Lawn WeatherFlow Daily Max Temp"
    unique_id: lawn_weatherflow_daily_max_temp
    entity_id: sensor.weatherflow_sensors_temperature
    state_characteristic: value_max
    sampling_size: 2000
    max_age:
      hours: 24
    precision: 1

  - platform: statistics
    name: "Lawn WeatherFlow Daily Min Temp"
    unique_id: lawn_weatherflow_daily_min_temp
    entity_id: sensor.weatherflow_sensors_temperature
    state_characteristic: value_min
    sampling_size: 2000
    max_age:
      hours: 24
    precision: 1

# =============================================================================
# TEMPLATE SENSORS â€” GDD Engine
# lawn_daily_max_temp and lawn_daily_min_temp now read from the statistics
# sensors above for accurate true daily highs and lows. Falls back to the
# live reading if the stats sensor is still warming up.
# =============================================================================

template:
  - sensor:
      - name: "Lawn Daily Max Temp"
        unique_id: lawn_daily_max_temp
        state: >
          {% set stat = states('sensor.lawn_weatherflow_daily_max_temp') %}
          {% if stat not in ['unknown', 'unavailable'] %}
            {{ stat | round(1) }}
          {% else %}
            {{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}
          {% endif %}
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-up

      - name: "Lawn Daily Min Temp"
        unique_id: lawn_daily_min_temp
        state: >
          {% set stat = states('sensor.lawn_weatherflow_daily_min_temp') %}
          {% if stat not in ['unknown', 'unavailable'] %}
            {{ stat | round(1) }}
          {% else %}
            {{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}
          {% endif %}
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-down

      - name: "Lawn GDD Today"
        unique_id: lawn_gdd_today
        state: >
          {% set max_temp = states('sensor.lawn_daily_max_temp') | float(0) %}
          {% set min_temp = states('sensor.lawn_daily_min_temp') | float(0) %}
          {% set base_temp = 10 %}
          {% set gdd = ((max_temp + min_temp) / 2) - base_temp %}
          {{ [gdd, 0] | max | round(1) }}
        unit_of_measurement: "GDD"
        icon: mdi:thermometer-lines

# =============================================================================
# SCRIPTS â€” Task Logging
# =============================================================================

script:

  lawn_log_mowing:
    alias: "Log Mowing"
    icon: mdi:mower-on
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_mowing
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Lawn Mowing"
          message: >
            Mowed the lawn.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_mowing
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_kelp:
    alias: "Log Kelp Application"
    icon: mdi:seed
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_kelp
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Kelp Application"
          message: >
            Applied kelp at {{ states('input_number.lawn_rate_kelp') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_kelp') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_kelp') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_kelp
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_granular_fert:
    alias: "Log Granular Fertiliser"
    icon: mdi:shaker-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_granular_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Granular Fertiliser"
          message: >
            Applied granular fertiliser at {{ states('input_number.lawn_rate_granular_fert') }}g/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_granular_fert') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}g.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_granular_fert') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}g.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_granular_fert
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_liquid_fert:
    alias: "Log Liquid Fertiliser"
    icon: mdi:water-circle
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_liquid_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Liquid Fertiliser"
          message: >
            Applied liquid fertiliser at {{ states('input_number.lawn_rate_liquid_fert') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_liquid_fert') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_liquid_fert') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_liquid_fert
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_humate:
    alias: "Log Humate Application"
    icon: mdi:cup-water
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_humate
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Humate Application"
          message: >
            Applied humate at {{ states('input_number.lawn_rate_humate') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_humate') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_humate') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_humate
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_soil_wetter:
    alias: "Log Soil Wetter"
    icon: mdi:water-percent
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_soil_wetter
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Soil Wetter Application"
          message: >
            Applied soil wetter at {{ states('input_number.lawn_rate_soil_wetter') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_soil_wetter') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_soil_wetter') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_soil_wetter
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_preemergent:
    alias: "Log Pre-emergent"
    icon: mdi:shield-bug
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_preemergent
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Pre-emergent Application"
          message: >
            Applied pre-emergent at {{ states('input_number.lawn_rate_preemergent') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_preemergent') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_preemergent') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_preemergent
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_insecticide:
    alias: "Log Insecticide"
    icon: mdi:bug-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_insecticide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Insecticide Application"
          message: >
            Applied insecticide at {{ states('input_number.lawn_rate_insecticide') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_insecticide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_insecticide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_insecticide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_fungicide:
    alias: "Log Fungicide"
    icon: mdi:mushroom-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_fungicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Fungicide Application"
          message: >
            Applied fungicide at {{ states('input_number.lawn_rate_fungicide') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_fungicide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_fungicide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_fungicide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_herbicide:
    alias: "Log Herbicide"
    icon: mdi:sprout-outline
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_herbicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "Herbicide Application"
          message: >
            Applied herbicide at {{ states('input_number.lawn_rate_herbicide') }}ml/100mÂ².
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_herbicide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_herbicide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_herbicide
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_pgr:
    alias: "Log PGR Application"
    icon: mdi:expansion-card-variant
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_pgr
        data:
          timestamp: "{{ now().timestamp() }}"
      - service: logbook.log
        data:
          name: "PGR Application"
          message: >
            Applied PGR at {{ states('input_number.lawn_rate_pgr') }}ml/100mÂ²
            ({{ states('input_number.pgr_gdd_accumulated') }} GDD accumulated â€” resetting to 0).
            Front ({{ states('input_number.lawn_area_front') }}mÂ²): {{ ((states('input_number.lawn_rate_pgr') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml.
            Back ({{ states('input_number.lawn_area_back') }}mÂ²): {{ ((states('input_number.lawn_rate_pgr') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml.
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_pgr
      - service: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: 0
      - service: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

# =============================================================================
# AUTOMATIONS â€” GDD Accumulation & Task Reminders
# =============================================================================

automation:

  # â”€â”€ GDD: Accumulate daily at midnight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_gdd_accumulate
    alias: "Lawn: Accumulate Daily GDD"
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: >
            {{ (states('input_number.pgr_gdd_accumulated') | float
                + states('sensor.lawn_gdd_today') | float) | round(1) }}

  # â”€â”€ GDD: PGR threshold alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_pgr_gdd_alert
    alias: "Lawn: PGR GDD Threshold Reached"
    trigger:
      - platform: numeric_state
        entity_id: input_number.pgr_gdd_accumulated
        above: input_number.pgr_gdd_target
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸŒ± PGR Application Due"
          message: >
            Target GDD reached! Accumulated: {{ states('input_number.pgr_gdd_accumulated') }} /
            {{ states('input_number.pgr_gdd_target') }} GDD.

            Mix for Front Lawn ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_pgr') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back Lawn ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_pgr') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Mowing Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_mowing_reminder
    alias: "Lawn: Mowing Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_mowing')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_mowing') | float(7) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸšœ Time to Mow"
          message: >
            It's been {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_mowing'))) / 86400) | round(0) }} days since last mow
            (interval: {{ states('input_number.lawn_interval_mowing') | round(0) }} days).

  # â”€â”€ Kelp Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_kelp_reminder
    alias: "Lawn: Kelp Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_kelp')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_kelp') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸŒ¿ Kelp Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_kelp'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_kelp') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_kelp') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Granular Fertiliser Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_granular_fert_reminder
    alias: "Lawn: Granular Fertiliser Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_granular_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_granular_fert') | float(60) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ¥£ Granular Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_granular_fert'))) / 86400) | round(0) }} days since last application.

            Spread on Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_granular_fert') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}g

            Spread on Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_granular_fert') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}g

  # â”€â”€ Liquid Fertiliser Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_liquid_fert_reminder
    alias: "Lawn: Liquid Fertiliser Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_liquid_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_liquid_fert') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ’§ Liquid Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_liquid_fert'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_liquid_fert') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_liquid_fert') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Humate Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_humate_reminder
    alias: "Lawn: Humate Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_humate')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_humate') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "â˜• Humate Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_humate'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_humate') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_humate') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Soil Wetter Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_soil_wetter_reminder
    alias: "Lawn: Soil Wetter Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_soil_wetter')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_soil_wetter') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ’¦ Soil Wetter Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_soil_wetter'))) / 86400) | round(0) }} days since last application.
            Critical for Perth sandy soil â€” don't skip this one!

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_soil_wetter') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_soil_wetter') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Pre-emergent Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_preemergent_reminder
    alias: "Lawn: Pre-emergent Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_preemergent')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_preemergent') | float(120) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ›¡ï¸ Pre-emergent Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_preemergent'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_preemergent') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_preemergent') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Insecticide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_insecticide_reminder
    alias: "Lawn: Insecticide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_insecticide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_insecticide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ› Insecticide Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_insecticide'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_insecticide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_insecticide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Fungicide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_fungicide_reminder
    alias: "Lawn: Fungicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_fungicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_fungicide') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸ„ Fungicide Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_fungicide'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_fungicide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_fungicide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml

  # â”€â”€ Herbicide Reminder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: lawn_herbicide_reminder
    alias: "Lawn: Herbicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: template
        value_template: >
          {% set last = as_timestamp(states('input_datetime.lawn_last_herbicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_herbicide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - service: notify.mobile_app_marcs_iphone
        data:
          title: "ğŸŒ± Herbicide Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_herbicide'))) / 86400) | round(0) }} days since last application.

            Mix for Front ({{ states('input_number.lawn_area_front') }}mÂ²):
            {{ ((states('input_number.lawn_rate_herbicide') | float * states('input_number.lawn_area_front') | float) / 100) | round(1) }}ml

            Mix for Back ({{ states('input_number.lawn_area_back') }}mÂ²):
            {{ ((states('input_number.lawn_rate_herbicide') | float * states('input_number.lawn_area_back') | float) / 100) | round(1) }}ml
