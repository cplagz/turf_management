# =============================================================================
# Perth Turf Management System v3.0 â€” Home Assistant Package
# Save as: config/packages/lawn_care.yaml
#
# NEW IN v3.0 (patched from v2.1):
# âœ“ Migrated all service: â†’ action: (HA 2024.8+ compliance)
# âœ“ Fixed YAML anchor dereference inside Jinja2 templates
# âœ“ Merged GDD accumulate + temp reset (eliminates race condition)
# âœ“ Robust unavailable/unknown guards on all temp tracking
# âœ“ PGR Days-Until now uses 5-day projection average (stable overnight)
# âœ“ Inventory Tracking with auto-deduct on log scripts
# âœ“ Low Stock alert sensor + automation
# âœ“ ETâ‚€ irrigation estimate (Hargreaves) + irrigation minutes sensor
# âœ“ Soil moisture probe integration (suppresses watering when wet)
# âœ“ Nitrogen tracking (cumulative season counter)
# âœ“ Notification toggle switches (carried forward)
# âœ“ Multi-area support (up to 5 configurable areas)
# âœ“ Lawn type selector (affects GDD calculation)
# âœ“ Spray conditions forecast (wind + rain analysis)
# âœ“ 2024.4+ Weather Forecast Compatibility built-in
# =============================================================================

# =============================================================================
# ðŸ”§ USER CONFIGURATION â€” EDIT THESE THREE LINES FOR YOUR SETUP
# =============================================================================
#
# IMPORTANT: Unlike v2.1, anchors are NO LONGER used inside Jinja2 templates.
# Edit the three values below. Then do a GLOBAL find-and-replace for
# the corresponding entity IDs if you use different sensors:
#
#   Temperature sensor  â†’ sensor.weatherflow_sensors_temperature
#   Notify service      â†’ notify.mobile_app_marcs_iphone
#   Weather forecast    â†’ weather.weatherflow_forecast_home
#
# (Search for "# âš™ï¸ USER-CONFIG" comments throughout this file to locate
#  all hardcoded references that need changing for your setup.)
# =============================================================================

homeassistant:
  customize:
    sensor.lawn_gdd_today:
      friendly_name: "Today's GDD"
      icon: mdi:thermometer-lines

    # Anchors â€” used ONLY for entity_id references in trigger/target blocks
    # (never inside Jinja2 {{ }} template strings)
    package.lawn_temp_sensor: &temp_sensor sensor.weatherflow_sensors_temperature
    package.lawn_notify_service: &notify_service notify.mobile_app_marcs_iphone
    package.lawn_weather: &weather_forecast weather.weatherflow_forecast_home

    # Give device_class to input_numbers so they graph properly
    # (eliminates the need for wrapper template sensors)
    input_number.lawn_temp_daily_max:
      device_class: temperature
      state_class: measurement
    input_number.lawn_temp_daily_min:
      device_class: temperature
      state_class: measurement

# =============================================================================
# INPUT BOOLEAN â€” Notification Toggles
# =============================================================================

input_boolean:
  lawn_notify_mowing:
    name: "Notify: Mowing"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_kelp:
    name: "Notify: Kelp"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_granular_fert:
    name: "Notify: Granular Fert"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_liquid_fert:
    name: "Notify: Liquid Fert"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_humate:
    name: "Notify: Humate"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_soil_wetter:
    name: "Notify: Soil Wetter"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_preemergent:
    name: "Notify: Pre-emergent"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_insecticide:
    name: "Notify: Insecticide"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_fungicide:
    name: "Notify: Fungicide"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_herbicide:
    name: "Notify: Herbicide"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_pgr:
    name: "Notify: PGR"
    icon: mdi:bell-ring
    initial: true
  lawn_notify_low_stock:
    name: "Notify: Low Stock"
    icon: mdi:bell-alert
    initial: true
  lawn_notify_irrigation:
    name: "Notify: Irrigation"
    icon: mdi:bell-ring
    initial: true

# =============================================================================
# INPUT SELECT â€” Lawn Type
# =============================================================================

input_select:
  lawn_type:
    name: Lawn Type
    options:
      - "Cool Season (C3)"
      - "Warm Season (C4)"
      - "Bermuda"
      - "Kikuyu"
      - "Buffalo"
    initial: "Warm Season (C4)"
    icon: mdi:grass

# =============================================================================
# INPUT NUMBER â€” Lawn Areas, Rates, Intervals, GDD, Inventory, Irrigation
# =============================================================================

input_number:

  # â”€â”€ Lawn Areas (5 configurable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_area_1_size:
    name: "Area 1: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_2_size:
    name: "Area 2: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_3_size:
    name: "Area 3: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_4_size:
    name: "Area 4: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  lawn_area_5_size:
    name: "Area 5: Size"
    min: 0
    max: 1000
    step: 1
    unit_of_measurement: "mÂ²"
    icon: mdi:texture-box
    mode: box

  # â”€â”€ Application Rates (per 100mÂ²) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_rate_granular_fert:
    name: Granular Fertiliser Rate
    min: 0
    max: 5
    step: 0.1
    unit_of_measurement: "kg/100mÂ²"
    icon: mdi:shaker-outline
    mode: box

  lawn_rate_liquid_fert:
    name: Liquid Fertiliser Rate
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-circle
    mode: box

  lawn_rate_kelp:
    name: Kelp Rate
    min: 0
    max: 500
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:seed
    mode: box

  lawn_rate_humate:
    name: Humate Rate
    min: 0
    max: 500
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:cup-water
    mode: box

  lawn_rate_soil_wetter:
    name: Soil Wetter Rate
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:water-percent
    mode: box

  lawn_rate_preemergent:
    name: Pre-emergent Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:shield-bug
    mode: box

  lawn_rate_insecticide:
    name: Insecticide Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:bug-outline
    mode: box

  lawn_rate_fungicide:
    name: Fungicide Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:mushroom-outline
    mode: box

  lawn_rate_herbicide:
    name: Herbicide Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:sprout-outline
    mode: box

  lawn_rate_pgr:
    name: PGR Rate
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "ml/100mÂ²"
    icon: mdi:expansion-card-variant
    mode: box

  # â”€â”€ Task Intervals (Days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_interval_mowing:
    name: Mowing Interval
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mower-on
    mode: box

  lawn_interval_kelp:
    name: Kelp Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:seed
    mode: box

  lawn_interval_granular_fert:
    name: Granular Fert Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shaker-outline
    mode: box

  lawn_interval_liquid_fert:
    name: Liquid Fert Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-circle
    mode: box

  lawn_interval_humate:
    name: Humate Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:cup-water
    mode: box

  lawn_interval_soil_wetter:
    name: Soil Wetter Interval
    min: 1
    max: 120
    step: 1
    unit_of_measurement: "days"
    icon: mdi:water-percent
    mode: box

  lawn_interval_preemergent:
    name: Pre-emergent Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:shield-bug
    mode: box

  lawn_interval_insecticide:
    name: Insecticide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:bug-outline
    mode: box

  lawn_interval_fungicide:
    name: Fungicide Interval
    min: 1
    max: 90
    step: 1
    unit_of_measurement: "days"
    icon: mdi:mushroom-outline
    mode: box

  lawn_interval_herbicide:
    name: Herbicide Interval
    min: 1
    max: 180
    step: 1
    unit_of_measurement: "days"
    icon: mdi:sprout-outline
    mode: box

  # â”€â”€ GDD Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  pgr_gdd_accumulated:
    name: Accumulated GDD
    min: 0
    max: 2000
    step: 0.1
    unit_of_measurement: "GDD"
    icon: mdi:chart-line
    mode: box

  pgr_gdd_target:
    name: Target GDD for PGR
    min: 50
    max: 500
    step: 10
    unit_of_measurement: "GDD"
    icon: mdi:target
    mode: box

  # â”€â”€ Temperature Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_temp_daily_max:
    name: "Today's Max Temp"
    min: -20
    max: 60
    step: 0.1
    unit_of_measurement: "Â°C"
    icon: mdi:thermometer-chevron-up
    mode: box

  lawn_temp_daily_min:
    name: "Today's Min Temp"
    min: -20
    max: 60
    step: 0.1
    unit_of_measurement: "Â°C"
    icon: mdi:thermometer-chevron-down
    mode: box

  # â”€â”€ Inventory / Stock Levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Set these to your current stock when first installing.

  lawn_stock_kelp:
    name: "Stock: Kelp"
    min: 0
    max: 50000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic
    mode: box

  lawn_stock_granular_fert:
    name: "Stock: Granular Fert"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "kg"
    icon: mdi:sack
    mode: box

  lawn_stock_liquid_fert:
    name: "Stock: Liquid Fert"
    min: 0
    max: 50000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic-outline
    mode: box

  lawn_stock_humate:
    name: "Stock: Humate"
    min: 0
    max: 50000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic-plus
    mode: box

  lawn_stock_soil_wetter:
    name: "Stock: Soil Wetter"
    min: 0
    max: 50000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-wine
    mode: box

  lawn_stock_preemergent:
    name: "Stock: Pre-emergent"
    min: 0
    max: 10000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic-skull
    mode: box

  lawn_stock_insecticide:
    name: "Stock: Insecticide"
    min: 0
    max: 10000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic-skull-outline
    mode: box

  lawn_stock_fungicide:
    name: "Stock: Fungicide"
    min: 0
    max: 10000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:bottle-tonic-plus-outline
    mode: box

  lawn_stock_herbicide:
    name: "Stock: Herbicide"
    min: 0
    max: 10000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:spray-bottle
    mode: box

  lawn_stock_pgr:
    name: "Stock: PGR"
    min: 0
    max: 10000
    step: 10
    unit_of_measurement: "ml"
    icon: mdi:spray
    mode: box

  lawn_stock_alert_threshold:
    name: "Low Stock Alert Threshold"
    min: 5
    max: 50
    step: 5
    unit_of_measurement: "%"
    icon: mdi:alert-outline
    mode: slider

  # â”€â”€ Irrigation Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_sprinkler_precip_rate:
    name: "Sprinkler Precipitation Rate"
    min: 1
    max: 40
    step: 0.5
    unit_of_measurement: "mm/hr"
    icon: mdi:sprinkler-variant
    mode: box

  lawn_moisture_threshold:
    name: "Soil Moisture Suppress Threshold"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:water-thermometer
    mode: slider

  # â”€â”€ Nitrogen Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  lawn_nitrogen_applied_season:
    name: "Nitrogen Applied (Season Total)"
    min: 0
    max: 100
    step: 0.01
    unit_of_measurement: "kg N"
    icon: mdi:atom
    mode: box

  lawn_granular_fert_n_fraction:
    name: "Granular Fert N Content"
    min: 0
    max: 1
    step: 0.01
    unit_of_measurement: "%/100"
    icon: mdi:percent
    mode: box

  lawn_liquid_fert_n_fraction:
    name: "Liquid Fert N Content"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "%/100"
    icon: mdi:percent
    mode: box


# =============================================================================
# INPUT TEXT â€” Area Names & Notes
# =============================================================================

input_text:

  lawn_area_1_name:
    name: "Area 1: Name"
    max: 50
    icon: mdi:label
    initial: "Front Yard"

  lawn_area_2_name:
    name: "Area 2: Name"
    max: 50
    icon: mdi:label
    initial: "Back Yard"

  lawn_area_3_name:
    name: "Area 3: Name"
    max: 50
    icon: mdi:label
    initial: "Side Yard"

  lawn_area_4_name:
    name: "Area 4: Name"
    max: 50
    icon: mdi:label
    initial: "Area 4"

  lawn_area_5_name:
    name: "Area 5: Name"
    max: 50
    icon: mdi:label
    initial: "Area 5"

  lawn_task_notes:
    name: Task Notes
    max: 255
    icon: mdi:note-text

# =============================================================================
# INPUT DATETIME â€” Last Applied
# =============================================================================

input_datetime:
  lawn_last_mowing:
    name: Last Mowed
    has_date: true
    has_time: true
    icon: mdi:mower-on

  lawn_last_kelp:
    name: Last Kelp
    has_date: true
    has_time: true
    icon: mdi:seed

  lawn_last_granular_fert:
    name: Last Granular Fert
    has_date: true
    has_time: true
    icon: mdi:shaker-outline

  lawn_last_liquid_fert:
    name: Last Liquid Fert
    has_date: true
    has_time: true
    icon: mdi:water-circle

  lawn_last_humate:
    name: Last Humate
    has_date: true
    has_time: true
    icon: mdi:cup-water

  lawn_last_soil_wetter:
    name: Last Soil Wetter
    has_date: true
    has_time: true
    icon: mdi:water-percent

  lawn_last_preemergent:
    name: Last Pre-emergent
    has_date: true
    has_time: true
    icon: mdi:shield-bug

  lawn_last_insecticide:
    name: Last Insecticide
    has_date: true
    has_time: true
    icon: mdi:bug-outline

  lawn_last_fungicide:
    name: Last Fungicide
    has_date: true
    has_time: true
    icon: mdi:mushroom-outline

  lawn_last_herbicide:
    name: Last Herbicide
    has_date: true
    has_time: true
    icon: mdi:sprout-outline

  lawn_last_pgr:
    name: Last PGR
    has_date: true
    has_time: true
    icon: mdi:expansion-card-variant


# =============================================================================
# TEMPLATE SENSORS
# =============================================================================

template:

  # â”€â”€ Trigger-Based Sensor: Fetch Forecast Data (hourly + on start) â”€â”€â”€â”€â”€â”€
  - trigger:
      - platform: time_pattern
        hours: "/1"
      - platform: homeassistant
        event: start
    action:
      - action: weather.get_forecasts
        target:
          entity_id: *weather_forecast    # âš™ï¸ USER-CONFIG
        data:
          type: daily
        response_variable: daily_forecast
    sensor:
      - name: "Lawn Weather Forecast Custom"
        unique_id: lawn_weather_forecast_custom
        state: "{{ now().strftime('%Y-%m-%d %H:%M') }}"
        icon: mdi:weather-partly-cloudy
        attributes:
          forecast: "{{ (daily_forecast.values() | list)[0].forecast }}"

  # â”€â”€ Standard Template Sensors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - sensor:

      # NOTE: The wrapper sensors for daily max/min temp from v2.1 have been
      # removed. The input_numbers now have device_class/state_class via
      # customize: â€” reference input_number.lawn_temp_daily_max directly.

      - name: "Lawn GDD Today"
        unique_id: lawn_gdd_today
        state: |
          {% set max_temp = states('input_number.lawn_temp_daily_max') | float(0) %}
          {% set min_temp = states('input_number.lawn_temp_daily_min') | float(0) %}
          {% set lawn_type = states('input_select.lawn_type') %}
          {% if 'Cool Season' in lawn_type %}
            {% set base_temp = 5 %}
          {% else %}
            {% set base_temp = 10 %}
          {% endif %}
          {% set gdd = ((max_temp + min_temp) / 2) - base_temp %}
          {{ [gdd, 0] | max | round(1) }}
        unit_of_measurement: "GDD"
        icon: mdi:thermometer-lines
        attributes:
          lawn_type: "{{ states('input_select.lawn_type') }}"
          base_temperature: |
            {% if 'Cool Season' in states('input_select.lawn_type') %}5{% else %}10{% endif %}

      - name: "Lawn Total Area"
        unique_id: lawn_total_area
        state: |
          {{ (states('input_number.lawn_area_1_size') | float(0) +
              states('input_number.lawn_area_2_size') | float(0) +
              states('input_number.lawn_area_3_size') | float(0) +
              states('input_number.lawn_area_4_size') | float(0) +
              states('input_number.lawn_area_5_size') | float(0)) | round(0) }}
        unit_of_measurement: "mÂ²"
        icon: mdi:texture-box

      - name: "Lawn Wind Speed Forecast"
        unique_id: lawn_wind_speed_forecast
        state: |
          {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
          {% if forecast %}
            {% set max_wind = namespace(value=0) %}
            {% for day in forecast[:1] %}
              {% if day.wind_speed is defined %}
                {% set wind = day.wind_speed | float(0) %}
                {% if wind > max_wind.value %}
                  {% set max_wind.value = wind %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ max_wind.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "km/h"
        icon: mdi:weather-windy
        device_class: wind_speed

      - name: "Lawn Rain Forecast"
        unique_id: lawn_rain_forecast
        state: |
          {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
          {% if forecast %}
            {% set total_rain = namespace(value=0) %}
            {% for day in forecast[:1] %}
              {% if day.precipitation is defined %}
                {% set total_rain.value = total_rain.value + (day.precipitation | float(0)) %}
              {% endif %}
            {% endfor %}
            {{ total_rain.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "mm"
        icon: mdi:weather-pouring
        device_class: precipitation

      - name: "Lawn Spray Conditions"
        unique_id: lawn_spray_conditions
        state: |
          {% set wind = states('sensor.lawn_wind_speed_forecast') | float(0) %}
          {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
          {% if wind > 25 or rain > 5 %}
            Poor
          {% elif wind > 15 or rain > 2 %}
            Marginal
          {% else %}
            Good
          {% endif %}
        icon: |
          {% set wind = states('sensor.lawn_wind_speed_forecast') | float(0) %}
          {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
          {% if wind > 25 or rain > 5 %}mdi:close-circle
          {% elif wind > 15 or rain > 2 %}mdi:alert-circle
          {% else %}mdi:check-circle{% endif %}
        attributes:
          wind_speed: "{{ states('sensor.lawn_wind_speed_forecast') }} km/h"
          rain_forecast: "{{ states('sensor.lawn_rain_forecast') }} mm"
          recommendation: |
            {% set wind = states('sensor.lawn_wind_speed_forecast') | float(0) %}
            {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
            {% if wind > 25 or rain > 5 %}
              Poor conditions. High wind or rain forecast â€” delay spraying.
            {% elif wind > 15 or rain > 2 %}
              Borderline conditions. Monitor wind and rain before spraying.
            {% else %}
              Ideal spray conditions. Low wind and minimal rain expected.
            {% endif %}

      - name: "Lawn Next Spray Window"
        unique_id: lawn_next_spray_window
        state: |
          {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
          {% if forecast %}
            {% set found = namespace(day='') %}
            {% for day in forecast[:7] %}
              {% if found.day == '' %}
                {% set wind = day.wind_speed | float(100) if day.wind_speed is defined else 100 %}
                {% set rain = day.precipitation | float(100) if day.precipitation is defined else 100 %}
                {% if wind < 15 and rain < 2 %}
                  {% set found.day = day.datetime if day.datetime is defined else 'Unknown' %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ found.day[:10] if found.day else 'No suitable window in next 7 days' }}
          {% else %}
            unavailable
          {% endif %}
        icon: mdi:calendar-check

      - name: "Lawn GDD Projection 5-Day"
        unique_id: lawn_gdd_projection_5day
        state: |
          {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
          {% set lawn_type = states('input_select.lawn_type') %}
          {% if 'Cool Season' in lawn_type %}
            {% set base_temp = 5 %}
          {% else %}
            {% set base_temp = 10 %}
          {% endif %}
          {% if forecast %}
            {% set total_gdd = namespace(value=0) %}
            {% for day in forecast[:5] %}
              {% if day.temperature is defined and day.templow is defined %}
                {% set max_t = day.temperature | float(0) %}
                {% set min_t = day.templow | float(0) %}
                {% set daily_gdd = ((max_t + min_t) / 2) - base_temp %}
                {% set total_gdd.value = total_gdd.value + ([daily_gdd, 0] | max) %}
              {% endif %}
            {% endfor %}
            {{ total_gdd.value | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "GDD"
        icon: mdi:calendar-range
        attributes:
          base_temperature: |
            {% if 'Cool Season' in states('input_select.lawn_type') %}5{% else %}10{% endif %}
          lawn_type: "{{ states('input_select.lawn_type') }}"
          days_available: |
            {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
            {{ [forecast | length, 5] | min if forecast else 0 }}

      - name: "Lawn PGR Days Until"
        unique_id: lawn_pgr_days_until
        state: |
          {% set current_gdd = states('input_number.pgr_gdd_accumulated') | float(0) %}
          {% set target_gdd = states('input_number.pgr_gdd_target') | float(200) %}
          {% set remaining = target_gdd - current_gdd %}
          {% if remaining <= 0 %}
            0
          {% else %}
            {% set proj_5d = states('sensor.lawn_gdd_projection_5day') | float(0) %}
            {% set daily_avg = (proj_5d / 5) if proj_5d > 0
                               else states('sensor.lawn_gdd_today') | float(0) %}
            {{ (remaining / daily_avg) | round(0) if daily_avg > 0 else 'unavailable' }}
          {% endif %}
        unit_of_measurement: "days"
        icon: mdi:calendar-clock
        attributes:
          current_gdd: "{{ states('input_number.pgr_gdd_accumulated') }}"
          target_gdd: "{{ states('input_number.pgr_gdd_target') }}"
          gdd_remaining: |
            {{ (states('input_number.pgr_gdd_target') | float(0) -
                states('input_number.pgr_gdd_accumulated') | float(0)) | round(1) }}

      - name: "Lawn PGR Forecast Date"
        unique_id: lawn_pgr_forecast_date
        state: |
          {% set current_gdd = states('input_number.pgr_gdd_accumulated') | float(0) %}
          {% set target_gdd = states('input_number.pgr_gdd_target') | float(200) %}
          {% set projection_5day = states('sensor.lawn_gdd_projection_5day') | float(0) %}
          {% if current_gdd >= target_gdd %}
            Now (Target Reached)
          {% elif current_gdd + projection_5day >= target_gdd %}
            {% set forecast = state_attr('sensor.lawn_weather_forecast_custom', 'forecast') %}
            {% set lawn_type = states('input_select.lawn_type') %}
            {% if 'Cool Season' in lawn_type %}
              {% set base_temp = 5 %}
            {% else %}
              {% set base_temp = 10 %}
            {% endif %}
            {% if forecast %}
              {% set running_gdd = namespace(value=current_gdd) %}
              {% set found_date = namespace(value='') %}
              {% for day in forecast[:7] %}
                {% if found_date.value == '' %}
                  {% if day.temperature is defined and day.templow is defined %}
                    {% set max_t = day.temperature | float(0) %}
                    {% set min_t = day.templow | float(0) %}
                    {% set daily_gdd = ((max_t + min_t) / 2) - base_temp %}
                    {% set running_gdd.value = running_gdd.value + ([daily_gdd, 0] | max) %}
                    {% if running_gdd.value >= target_gdd %}
                      {% set found_date.value = day.datetime if day.datetime is defined else '' %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ found_date.value[:10] if found_date.value else '5+ days' }}
            {% else %}
              Unknown
            {% endif %}
          {% else %}
            5+ days
          {% endif %}
        icon: mdi:calendar-star

      # â”€â”€ NEW: ETâ‚€ Irrigation Estimate (Hargreaves equation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # Uses a simplified Hargreaves model. The Ra (extraterrestrial radiation)
      # value of 15.0 MJ/mÂ²/day is approximate for Perth (~31.9Â°S).
      # Adjust if you're at a significantly different latitude.

      - name: "Lawn ET Estimate"
        unique_id: lawn_et_estimate
        state: |
          {% set max_t = states('input_number.lawn_temp_daily_max') | float(25) %}
          {% set min_t = states('input_number.lawn_temp_daily_min') | float(15) %}
          {% set avg_t = (max_t + min_t) / 2 %}
          {% set td = max_t - min_t %}
          {% if td < 0 %}{% set td = 0 %}{% endif %}
          {% set ra = 15.0 %}
          {% set et0 = 0.0023 * (avg_t + 17.8) * (td ** 0.5) * ra * 0.408 %}
          {{ [et0, 0] | max | round(2) }}
        unit_of_measurement: "mm/day"
        icon: mdi:water-outline
        device_class: precipitation
        state_class: measurement
        attributes:
          method: "Hargreaves (simplified)"
          ra_assumed: "15.0 MJ/mÂ²/day"

      - name: "Lawn Irrigation Minutes"
        unique_id: lawn_irrigation_minutes
        state: |
          {% set et = states('sensor.lawn_et_estimate') | float(0) %}
          {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
          {% set kc = 0.85 %}
          {% set net_demand = (et * kc) - rain %}
          {% set precip_rate = states('input_number.lawn_sprinkler_precip_rate') | float(12) %}
          {% if net_demand > 0.5 %}
            {{ ((net_demand / precip_rate) * 60) | round(0) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "min"
        icon: mdi:timer-outline
        attributes:
          et0: "{{ states('sensor.lawn_et_estimate') }} mm"
          rain_offset: "{{ states('sensor.lawn_rain_forecast') }} mm"
          net_demand_mm: |
            {% set et = states('sensor.lawn_et_estimate') | float(0) %}
            {% set rain = states('sensor.lawn_rain_forecast') | float(0) %}
            {{ ((et * 0.85) - rain) | round(2) }}

      # â”€â”€ NEW: Soil Moisture Average â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # Add your soil moisture sensor entity IDs below.
      # Supports any number of probes â€” just add them to the list.
      # If you don't have probes yet, this sensor will show "unavailable"
      # and all moisture conditions will gracefully pass through.

      - name: "Lawn Average Soil Moisture"
        unique_id: lawn_avg_soil_moisture
        state: |
          {% set probe_entities = [
            'sensor.soil_moisture_front',
            'sensor.soil_moisture_back',
          ] %}
          {% set valid = namespace(values=[]) %}
          {% for entity in probe_entities %}
            {% set val = states(entity) %}
            {% if val not in ['unavailable', 'unknown', 'none'] %}
              {% set valid.values = valid.values + [val | float(0)] %}
            {% endif %}
          {% endfor %}
          {% if valid.values | length > 0 %}
            {{ (valid.values | sum / valid.values | length) | round(1) }}
          {% else %}
            unavailable
          {% endif %}
        unit_of_measurement: "%"
        device_class: moisture
        icon: mdi:water-thermometer

      # â”€â”€ NEW: Low Stock Items Sensor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: "Lawn Low Stock Items"
        unique_id: lawn_low_stock_items
        state: |
          {% set threshold_pct = states('input_number.lawn_stock_alert_threshold') | float(20) / 100 %}
          {% set products = [
            ('Kelp',         'lawn_stock_kelp',          50000),
            ('Granular Fert','lawn_stock_granular_fert',  100),
            ('Liquid Fert',  'lawn_stock_liquid_fert',   50000),
            ('Humate',       'lawn_stock_humate',        50000),
            ('Soil Wetter',  'lawn_stock_soil_wetter',   50000),
            ('Pre-emergent', 'lawn_stock_preemergent',   10000),
            ('Insecticide',  'lawn_stock_insecticide',   10000),
            ('Fungicide',    'lawn_stock_fungicide',     10000),
            ('Herbicide',    'lawn_stock_herbicide',     10000),
            ('PGR',          'lawn_stock_pgr',           10000),
          ] %}
          {% set low = namespace(count=0) %}
          {% for name, entity, max_cap in products %}
            {% set current = states('input_number.' ~ entity) | float(0) %}
            {% if current <= (max_cap * threshold_pct) and current >= 0 %}
              {% set low.count = low.count + 1 %}
            {% endif %}
          {% endfor %}
          {{ low.count }}
        unit_of_measurement: "items"
        icon: |
          {% if states('sensor.lawn_low_stock_items') | int(0) > 0 %}
            mdi:alert-circle
          {% else %}
            mdi:check-circle
          {% endif %}
        attributes:
          details: |
            {% set threshold_pct = states('input_number.lawn_stock_alert_threshold') | float(20) / 100 %}
            {% set products = [
              ('Kelp',         'lawn_stock_kelp',          50000, 'ml'),
              ('Granular Fert','lawn_stock_granular_fert',  100,  'kg'),
              ('Liquid Fert',  'lawn_stock_liquid_fert',   50000, 'ml'),
              ('Humate',       'lawn_stock_humate',        50000, 'ml'),
              ('Soil Wetter',  'lawn_stock_soil_wetter',   50000, 'ml'),
              ('Pre-emergent', 'lawn_stock_preemergent',   10000, 'ml'),
              ('Insecticide',  'lawn_stock_insecticide',   10000, 'ml'),
              ('Fungicide',    'lawn_stock_fungicide',     10000, 'ml'),
              ('Herbicide',    'lawn_stock_herbicide',     10000, 'ml'),
              ('PGR',          'lawn_stock_pgr',           10000, 'ml'),
            ] %}
            {% set low = namespace(items=[]) %}
            {% for name, entity, max_cap, unit in products %}
              {% set current = states('input_number.' ~ entity) | float(0) %}
              {% if current <= (max_cap * threshold_pct) %}
                {% set low.items = low.items + [name ~ ': ' ~ current | round(0) ~ unit] %}
              {% endif %}
            {% endfor %}
            {{ low.items | join(' Â· ') if low.items else 'All stocked' }}


# =============================================================================
# SCRIPTS â€” Task Logging (with Inventory Auto-Deduct + Nitrogen Tracking)
# =============================================================================

script:

  lawn_log_mowing:
    alias: "Log Mowing"
    icon: mdi:mower-on
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_mowing
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Lawn Mowing"
          message: |
            Mowed lawn (Total: {{ states('sensor.lawn_total_area') }}mÂ²).
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_mowing
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_kelp:
    alias: "Log Kelp"
    icon: mdi:seed
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_kelp
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Kelp Application"
          message: |
            Applied kelp at {{ states('input_number.lawn_rate_kelp') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_kelp') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_kelp
      # â”€â”€ Inventory Auto-Deduct â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_kelp
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_kelp') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_kelp') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_granular_fert:
    alias: "Log Granular Fert"
    icon: mdi:shaker-outline
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_granular_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Granular Fertiliser"
          message: |
            Applied at {{ states('input_number.lawn_rate_granular_fert') }}kg/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_granular_fert') | float * size) / 100) | round(2) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'kg' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_granular_fert
      # â”€â”€ Inventory Auto-Deduct â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_granular_fert
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_granular_fert') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(2) %}
            {% set current = states('input_number.lawn_stock_granular_fert') | float(0) %}
            {{ [current - used, 0] | max }}
      # â”€â”€ Nitrogen Tracking â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_nitrogen_applied_season
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_granular_fert') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set n_frac = states('input_number.lawn_granular_fert_n_fraction') | float(0.20) %}
            {% set kg_applied = (rate * area / 100) %}
            {% set n_kg = kg_applied * n_frac %}
            {{ (states('input_number.lawn_nitrogen_applied_season') | float(0) + n_kg) | round(2) }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_liquid_fert:
    alias: "Log Liquid Fert"
    icon: mdi:water-circle
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_liquid_fert
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Liquid Fertiliser"
          message: |
            Applied at {{ states('input_number.lawn_rate_liquid_fert') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_liquid_fert') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_liquid_fert
      # â”€â”€ Inventory Auto-Deduct â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_liquid_fert
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_liquid_fert') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_liquid_fert') | float(0) %}
            {{ [current - used, 0] | max }}
      # â”€â”€ Nitrogen Tracking â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_nitrogen_applied_season
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_liquid_fert') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set n_frac = states('input_number.lawn_liquid_fert_n_fraction') | float(0.05) %}
            {% set ml_applied = (rate * area / 100) %}
            {% set n_kg = (ml_applied / 1000) * n_frac %}
            {{ (states('input_number.lawn_nitrogen_applied_season') | float(0) + n_kg) | round(3) }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_humate:
    alias: "Log Humate"
    icon: mdi:cup-water
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_humate
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Humate Application"
          message: |
            Applied at {{ states('input_number.lawn_rate_humate') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_humate') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_humate
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_humate
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_humate') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_humate') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_soil_wetter:
    alias: "Log Soil Wetter"
    icon: mdi:water-percent
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_soil_wetter
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Soil Wetter"
          message: |
            Applied at {{ states('input_number.lawn_rate_soil_wetter') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_soil_wetter') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_soil_wetter
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_soil_wetter
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_soil_wetter') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_soil_wetter') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_preemergent:
    alias: "Log Pre-emergent"
    icon: mdi:shield-bug
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_preemergent
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Pre-emergent"
          message: |
            Applied at {{ states('input_number.lawn_rate_preemergent') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_preemergent') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_preemergent
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_preemergent
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_preemergent') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_preemergent') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_insecticide:
    alias: "Log Insecticide"
    icon: mdi:bug-outline
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_insecticide
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Insecticide"
          message: |
            Applied at {{ states('input_number.lawn_rate_insecticide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_insecticide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_insecticide
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_insecticide
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_insecticide') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_insecticide') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_fungicide:
    alias: "Log Fungicide"
    icon: mdi:mushroom-outline
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_fungicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Fungicide"
          message: |
            Applied at {{ states('input_number.lawn_rate_fungicide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_fungicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_fungicide
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_fungicide
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_fungicide') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_fungicide') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_herbicide:
    alias: "Log Herbicide"
    icon: mdi:sprout-outline
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_herbicide
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "Herbicide"
          message: |
            Applied at {{ states('input_number.lawn_rate_herbicide') }}ml/100mÂ².
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_herbicide') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_herbicide
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_herbicide
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_herbicide') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_herbicide') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  lawn_log_pgr:
    alias: "Log PGR"
    icon: mdi:expansion-card-variant
    sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lawn_last_pgr
        data:
          timestamp: "{{ now().timestamp() }}"
      - action: logbook.log
        data:
          name: "PGR Application"
          message: |
            Applied PGR at {{ states('input_number.lawn_rate_pgr') }}ml/100mÂ²
            ({{ states('input_number.pgr_gdd_accumulated') }} GDD â€” resetting to 0).
            {% set areas = namespace(list='') %}
            {% for i in range(1, 6) %}
              {% set size = states('input_number.lawn_area_' ~ i ~ '_size') | float(0) %}
              {% if size > 0 %}
                {% set name = states('input_text.lawn_area_' ~ i ~ '_name') %}
                {% set amount = ((states('input_number.lawn_rate_pgr') | float * size) / 100) | round(1) %}
                {% set areas.list = areas.list ~ ' / ' ~ name ~ ' (' ~ size ~ 'mÂ²): ' ~ amount ~ 'ml' %}
              {% endif %}
            {% endfor %}
            {{ areas.list }}
            Notes: {{ states('input_text.lawn_task_notes') or 'None' }}
          entity_id: input_datetime.lawn_last_pgr
      - action: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: 0
      # â”€â”€ Inventory Auto-Deduct â”€â”€
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_stock_pgr
        data:
          value: |
            {% set rate = states('input_number.lawn_rate_pgr') | float(0) %}
            {% set area = states('sensor.lawn_total_area') | float(0) %}
            {% set used = (rate * area / 100) | round(1) %}
            {% set current = states('input_number.lawn_stock_pgr') | float(0) %}
            {{ [current - used, 0] | max }}
      - action: input_text.set_value
        target:
          entity_id: input_text.lawn_task_notes
        data:
          value: ""

  # â”€â”€ Utility Script: Reset Seasonal Nitrogen Counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lawn_reset_nitrogen_season:
    alias: "Reset Seasonal Nitrogen"
    icon: mdi:atom-variant
    sequence:
      - action: logbook.log
        data:
          name: "Nitrogen Reset"
          message: >
            Seasonal nitrogen counter reset from {{ states('input_number.lawn_nitrogen_applied_season') }}kg N.
          entity_id: input_number.lawn_nitrogen_applied_season
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_nitrogen_applied_season
        data:
          value: 0


# =============================================================================
# AUTOMATIONS â€” Temperature, GDD, Reminders, Irrigation, Stock Alerts
# =============================================================================

automation:

  # â”€â”€ Temperature Tracking (with robust unavailable/unknown guards) â”€â”€â”€â”€â”€â”€â”€â”€

  - id: lawn_temp_track_max
    alias: "Lawn: Track Daily Max"
    trigger:
      - platform: state
        entity_id: *temp_sensor    # âš™ï¸ USER-CONFIG
    condition:
      - condition: template
        value_template: |
          {% set val = states('sensor.weatherflow_sensors_temperature') %}
          {{ val not in ['unavailable', 'unknown']
             and val | float(0) > states('input_number.lawn_temp_daily_max') | float(-99) }}
    action:
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_max
        data:
          # âš™ï¸ USER-CONFIG: entity ID below
          value: "{{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}"

  - id: lawn_temp_track_min
    alias: "Lawn: Track Daily Min"
    trigger:
      - platform: state
        entity_id: *temp_sensor    # âš™ï¸ USER-CONFIG
    condition:
      - condition: template
        value_template: |
          {% set val = states('sensor.weatherflow_sensors_temperature') %}
          {{ val not in ['unavailable', 'unknown']
             and val | float(99) < states('input_number.lawn_temp_daily_min') | float(99) }}
    action:
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_min
        data:
          # âš™ï¸ USER-CONFIG: entity ID below
          value: "{{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}"

  # â”€â”€ MERGED: Daily GDD Accumulate + Temperature Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Runs at 23:59 to capture the full day's extremes before resetting.
  # Eliminates the v2.1 race condition between separate 00:00:00 / 00:00:30 triggers.

  - id: lawn_daily_gdd_cycle
    alias: "Lawn: Daily GDD Accumulate & Reset"
    trigger:
      - platform: time
        at: "23:59:00"
    action:
      # Step 1: Accumulate today's GDD onto the running total
      - action: input_number.set_value
        target:
          entity_id: input_number.pgr_gdd_accumulated
        data:
          value: |
            {{ (states('input_number.pgr_gdd_accumulated') | float(0)
                + states('sensor.lawn_gdd_today') | float(0)) | round(1) }}
      # Step 2: Brief delay to ensure step 1 completes
      - delay: "00:00:05"
      # Step 3: Reset daily max/min to current temperature
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_max
        data:
          # âš™ï¸ USER-CONFIG: entity ID below
          value: "{{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}"
      - action: input_number.set_value
        target:
          entity_id: input_number.lawn_temp_daily_min
        data:
          # âš™ï¸ USER-CONFIG: entity ID below
          value: "{{ states('sensor.weatherflow_sensors_temperature') | float(0) | round(1) }}"

  # â”€â”€ PGR GDD Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - id: lawn_pgr_gdd_alert
    alias: "Lawn: PGR GDD Alert"
    trigger:
      - platform: numeric_state
        entity_id: input_number.pgr_gdd_accumulated
        above: input_number.pgr_gdd_target
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_pgr
        state: "on"
    action:
      - action: *notify_service    # âš™ï¸ USER-CONFIG
        data:
          title: "ðŸŒ± PGR Application Due"
          message: |
            GDD Target Reached! {{ states('input_number.pgr_gdd_accumulated') }} / {{ states('input_number.pgr_gdd_target') }} GDD.
            Forecast: Apply by {{ states('sensor.lawn_pgr_forecast_date') }}.

  # â”€â”€ Task Reminders (all use action: instead of service:) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - id: lawn_mowing_reminder
    alias: "Lawn: Mowing Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_mowing
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_mowing')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_mowing') | float(7) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service    # âš™ï¸ USER-CONFIG
        data:
          title: "ðŸšœ Time to Mow"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_mowing'))) / 86400) | round(0) }} days since last mow.

  - id: lawn_kelp_reminder
    alias: "Lawn: Kelp Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_kelp
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_kelp')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_kelp') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸŒ¿ Kelp Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_kelp'))) / 86400) | round(0) }} days overdue.

  - id: lawn_granular_fert_reminder
    alias: "Lawn: Granular Fert Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_granular_fert
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_granular_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_granular_fert') | float(60) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ¥£ Granular Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_granular_fert'))) / 86400) | round(0) }} days overdue.

  - id: lawn_liquid_fert_reminder
    alias: "Lawn: Liquid Fert Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_liquid_fert
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_liquid_fert')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_liquid_fert') | float(14) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ’§ Liquid Fertiliser Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_liquid_fert'))) / 86400) | round(0) }} days overdue.

  - id: lawn_humate_reminder
    alias: "Lawn: Humate Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_humate
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_humate')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_humate') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "â˜• Humate Application Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_humate'))) / 86400) | round(0) }} days overdue.

  - id: lawn_soil_wetter_reminder
    alias: "Lawn: Soil Wetter Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_soil_wetter
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_soil_wetter')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_soil_wetter') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ’¦ Soil Wetter Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_soil_wetter'))) / 86400) | round(0) }} days overdue. Critical for Perth sandy soil!

  - id: lawn_preemergent_reminder
    alias: "Lawn: Pre-emergent Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_preemergent
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_preemergent')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_preemergent') | float(120) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ›¡ï¸ Pre-emergent Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_preemergent'))) / 86400) | round(0) }} days overdue.

  - id: lawn_insecticide_reminder
    alias: "Lawn: Insecticide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_insecticide
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_insecticide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_insecticide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ› Insecticide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_insecticide'))) / 86400) | round(0) }} days overdue.

  - id: lawn_fungicide_reminder
    alias: "Lawn: Fungicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_fungicide
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_fungicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_fungicide') | float(30) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸ„ Fungicide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_fungicide'))) / 86400) | round(0) }} days overdue.

  - id: lawn_herbicide_reminder
    alias: "Lawn: Herbicide Reminder"
    trigger:
      - platform: time
        at: "08:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_herbicide
        state: "on"
      - condition: template
        value_template: |
          {% set last = as_timestamp(states('input_datetime.lawn_last_herbicide')) | float(0) %}
          {% set interval = states('input_number.lawn_interval_herbicide') | float(90) %}
          {{ (now().timestamp() - last) > (interval * 86400) }}
    action:
      - action: *notify_service
        data:
          title: "ðŸŒ± Herbicide Due"
          message: >
            {{ ((now().timestamp() - as_timestamp(states('input_datetime.lawn_last_herbicide'))) / 86400) | round(0) }} days overdue.

  # â”€â”€ NEW: Low Stock Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  - id: lawn_low_stock_alert
    alias: "Lawn: Low Stock Alert"
    trigger:
      - platform: numeric_state
        entity_id: sensor.lawn_low_stock_items
        above: 0
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_low_stock
        state: "on"
    action:
      - action: *notify_service
        data:
          title: "ðŸ“¦ Low Lawn Care Stock"
          message: |
            {{ states('sensor.lawn_low_stock_items') }} product(s) running low:
            {{ state_attr('sensor.lawn_low_stock_items', 'details') }}

  # â”€â”€ NEW: Irrigation Suggestion Notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Sends a notification if irrigation is recommended. Does NOT auto-control
  # valves (add your own switch actions if you have relay-controlled valves).

  - id: lawn_irrigation_notify
    alias: "Lawn: Irrigation Suggestion"
    trigger:
      - platform: time
        at: "05:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.lawn_notify_irrigation
        state: "on"
      - condition: numeric_state
        entity_id: sensor.lawn_irrigation_minutes
        above: 0
      # Suppress if soil is already wet (gracefully skips if sensor unavailable)
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.lawn_avg_soil_moisture
            state: "unavailable"
          - condition: numeric_state
            entity_id: sensor.lawn_avg_soil_moisture
            below: input_number.lawn_moisture_threshold
    action:
      - action: *notify_service
        data:
          title: "ðŸ’§ Irrigation Recommended"
          message: |
            ETâ‚€: {{ states('sensor.lawn_et_estimate') }}mm Â· Rain forecast: {{ states('sensor.lawn_rain_forecast') }}mm
            Suggested runtime: {{ states('sensor.lawn_irrigation_minutes') }} minutes.
            {% if states('sensor.lawn_avg_soil_moisture') != 'unavailable' %}
            Soil moisture: {{ states('sensor.lawn_avg_soil_moisture') }}%
            {% endif %}
